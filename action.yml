name: AutoLighthouse
description: Maximalist Lighthouse CI with zero config. Includes preset-based thresholds, multi-URL/multi-profile auditing, serverless regression detection, and automatic GitHub Issue lifecycle management. No hosted LHCI server required.
branding:
  icon: zap
  color: orange

inputs:
  mode:
    description: "Action mode: audit (run Lighthouse) or report (aggregate and analyze results)."
    required: false
    default: audit
  urls:
    description: Newline-separated list of URLs to audit. Required for audit mode.
    required: false
  profile:
    description: Device profile for this run (mobile, tablet, or desktop).
    required: false
    default: mobile
  preset:
    description: "Assertion preset: strict (default), moderate, or relaxed."
    required: false
    default: strict
  runs:
    description: Number of Lighthouse runs per URL (median aggregation).
    required: false
    default: "5"
  regression-threshold:
    description: Percentage increase from rolling average to flag as regression.
    required: false
    default: "10"
  consecutive-fail-limit:
    description: Consecutive failures before persistent alert.
    required: false
    default: "3"
  fail-on:
    description: "When to fail the workflow: error, warn, or never."
    required: false
    default: error
  budgets:
    description: true for built-in budgets, false to disable, or path to custom budget.json.
    required: false
    default: "true"
  create-issues:
    description: Enable GitHub Issue lifecycle management.
    required: false
    default: "true"
  upload-artifacts:
    description: Upload Lighthouse results as GitHub Actions artifacts.
    required: false
    default: "true"
  temporary-public-storage:
    description: Upload reports to temporary public storage for shareable links.
    required: false
    default: "true"
  history-path:
    description: Path for regression history JSON file. Set to empty string to disable history and regression detection.
    required: false
    default: .lighthouse/history.json
  cleanup-stale-paths:
    description: Remove history entries for URL/profile combinations no longer being audited.
    required: false
    default: "false"
  stale-path-days:
    description: Days to wait before removing stale history entries (requires cleanup-stale-paths to be true).
    required: false
    default: "30"
  max-history-runs:
    description: Maximum number of history runs to keep per URL/profile combination.
    required: false
    default: "100"
  github-token:
    description: GitHub token for issue management and history commits.
    required: false
    default: ${{ github.token }}

outputs:
  results:
    description: JSON string of all audit results (per-URL metrics, pass/fail, regressions).
    value: ${{ steps.analyze.outputs.results }}
  regressions:
    description: JSON string of detected regressions.
    value: ${{ steps.analyze.outputs.regressions }}
  has-regressions:
    description: "'true' or 'false' for easy conditional use in workflows."
    value: ${{ steps.analyze.outputs.has-regressions }}

runs:
  using: composite
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        if [[ "${{ inputs.mode }}" != "audit" && "${{ inputs.mode }}" != "report" ]]; then
          echo "::error::Invalid mode '${{ inputs.mode }}'. Must be 'audit' or 'report'."
          exit 1
        fi
        if [[ "${{ inputs.mode }}" == "audit" && -z "${{ inputs.urls }}" ]]; then
          echo "::error::The 'urls' input is required for audit mode."
          exit 1
        fi

    # ── Audit mode ──────────────────────────────────────────────

    - name: Generate Lighthouse config
      if: inputs.mode == 'audit'
      id: config
      shell: bash
      run: node "${{ github.action_path }}/dist/audit.js"
      env:
        INPUT_PROFILE: ${{ inputs.profile }}
        INPUT_PRESET: ${{ inputs.preset }}
        INPUT_URLS: ${{ inputs.urls }}
        INPUT_RUNS: ${{ inputs.runs }}
        INPUT_BUDGETS: ${{ inputs.budgets }}

    - name: Run Lighthouse
      if: inputs.mode == 'audit'
      id: lighthouse
      uses: treosh/lighthouse-ci-action@fcd65974f7c4c2bf0ee9d09b84d2489183c29726 # v12.6.1
      with:
        urls: ${{ inputs.urls }}
        configPath: ${{ steps.config.outputs.config-path }}
        budgetPath: ${{ steps.config.outputs.budget-path }}
        uploadArtifacts: false
        temporaryPublicStorage: ${{ inputs.temporary-public-storage }}
        runs: ${{ inputs.runs }}

    - name: Save audit metadata
      if: inputs.mode == 'audit'
      shell: bash
      env:
        RESULTS_PATH: ${{ steps.lighthouse.outputs.resultsPath }}
        ASSERTIONS: ${{ steps.lighthouse.outputs.assertionResults }}
        LINKS: ${{ steps.lighthouse.outputs.links }}
        PROFILE: ${{ inputs.profile }}
      run: |
        echo "$ASSERTIONS" > "$RESULTS_PATH/assertion-results.json"
        echo "$LINKS" > "$RESULTS_PATH/links.json"
        echo "$PROFILE" > "$RESULTS_PATH/profile.txt"

    - name: Upload audit results
      if: inputs.mode == 'audit'
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: autolighthouse-${{ inputs.profile }}
        path: ${{ steps.lighthouse.outputs.resultsPath }}
        retention-days: 90

    # ── Report mode ─────────────────────────────────────────────

    - name: Download audit results
      if: inputs.mode == 'report'
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        pattern: autolighthouse-*
        path: .autolighthouse-results

    - name: Analyze results
      if: inputs.mode == 'report'
      id: analyze
      shell: bash
      run: node "${{ github.action_path }}/dist/report.js"
      env:
        INPUT_RESULTS_PATH: .autolighthouse-results
        INPUT_REGRESSION_THRESHOLD: ${{ inputs.regression-threshold }}
        INPUT_CONSECUTIVE_FAIL_LIMIT: ${{ inputs.consecutive-fail-limit }}
        INPUT_FAIL_ON: ${{ inputs.fail-on }}
        INPUT_CREATE_ISSUES: ${{ inputs.create-issues }}
        INPUT_HISTORY_PATH: ${{ inputs.history-path }}
        INPUT_CLEANUP_STALE_PATHS: ${{ inputs.cleanup-stale-paths }}
        INPUT_STALE_PATH_DAYS: ${{ inputs.stale-path-days }}
        INPUT_MAX_HISTORY_RUNS: ${{ inputs.max-history-runs }}
        INPUT_GITHUB_TOKEN: ${{ inputs.github-token }}
